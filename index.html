<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ASEAN UNION Portal</title>

  
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light text-dark">
  <div class="container py-5">
    <h1 class="text-center mb-4">ASEAN UNION Prototype Portal</h1>

    <div class="d-grid gap-2 col-6 mx-auto">
      <button id="connectBtn" class="btn btn-primary">Connect Wallet</button>
      <div id="walletAddress" class="mt-2 fw-bold text-center"></div>
    </div>

    <div class="mt-4">
      <h4>üì¶ Registered Modules (via ASEANRegistry)</h4>
      <ul class="list-group" id="moduleList"></ul>
    </div>

    <div class="mt-4">
      <h4>üí∞ Your ASEANX Balance</h4>
      <p id="aseanxBalance" class="fw-semibold"></p>
    </div>
  </div>
<!-- ‚úÖ Load Ethers.js (Works in all browsers including Edge) -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
<script>
  const registryAddress = "0xF793721549fc423E62FcdB2491B378a55EB9bB42";
  const aseanxAddress = "0x44D7b726D4F64493E819C40ABB7f25d633bF404D";

  let cleanRegistryAddress;
  try {
    cleanRegistryAddress = ethers.getAddress(registryAddress.trim());
  } catch (err) {
    console.error("üö´ Invalid registry address format:", registryAddress);
    // ‚ùå `return` is illegal here ‚Äî just don't assign or throw
    cleanRegistryAddress = null;
  }

  const ASEANRegistryABI = [
    "function getModule(uint8) view returns (address)"
  ];

  const ASEANXABI = [
    "function balanceOf(address) view returns (uint256)",
    "function symbol() view returns (string)"
  ];

  const moduleNames = [
    "ASEANXToken",
    "CitizenNFT",
    "Governance",
    "ProjectFunding",
    "Marketplace",
    "OracleBridge",
    "StakingVault",
    "Migration"
  ];

  let provider, signer;

  async function connectWallet() {
    try {
      if (typeof window.ethereum === 'undefined') {
        alert("MetaMask not detected. Please install MetaMask.");
        return;
      }

      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      const walletAddress = accounts[0];

      provider = new ethers.BrowserProvider(window.ethereum);
      signer = await provider.getSigner();

      document.getElementById('walletAddress').innerText = walletAddress;
      document.getElementById('connectBtn').innerText = "Connected";
      document.getElementById('connectBtn').disabled = true;

      await getASEANXBalance(walletAddress);
      await fetchModules();

      console.log("‚úÖ Connected:", walletAddress);
    } catch (error) {
      console.error("‚ùå Connection failed:", error);
      alert("Failed to connect wallet. Please approve the connection in MetaMask.");
    }
  }

  async function fetchModules() {
    if (!cleanRegistryAddress) {
      console.error("‚ùå Registry address is invalid or not set.");
      return;
    }

    try {
      const registry = new ethers.Contract(cleanRegistryAddress, ASEANRegistryABI, provider);
      const list = document.getElementById("moduleList");
      list.innerHTML = "";

      for (let i = 0; i < moduleNames.length; i++) {
        const addr = await registry.getModule(i);
        console.log(`Module ${moduleNames[i]} (index ${i}):`, addr);

        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `<span>${moduleNames[i]}</span><code>${addr}</code>`;
        list.appendChild(li);
      }
    } catch (err) {
      console.error("‚ùå Error fetching modules from ASEANRegistry:", err);
      alert("Failed to load modules from registry. See console for details.");
    }
  }

  async function getASEANXBalance(addr) {
    try {
      const token = new ethers.Contract(aseanxAddress, ASEANXABI, provider);
      const bal = await token.balanceOf(addr);
      const symbol = await token.symbol();

      document.getElementById("aseanxBalance").textContent =
        `${ethers.formatUnits(bal, 18)} ${symbol}`;
    } catch (err) {
      console.error("‚ùå Failed to fetch ASEANX balance:", err);
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('connectBtn')?.addEventListener('click', connectWallet);
  });
</script>



</body>
</html>
