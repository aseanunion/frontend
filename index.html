<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ASEAN UNION Portal</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
  
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light text-dark">
  <div class="container py-5">
    <h1 class="text-center mb-4">ASEAN UNION Prototype Portal</h1>

    <div class="d-grid gap-2 col-6 mx-auto">
      <button id="connectBtn" class="btn btn-primary">Connect Wallet</button>
      <div id="walletAddress" class="mt-2 fw-bold text-center"></div>
    </div>

    <div class="mt-4">
      <h4>üì¶ Registered Modules (via ASEANRegistry)</h4>
      <ul class="list-group" id="moduleList"></ul>
    </div>

    <div class="mt-4">
      <h4>üí∞ Your ASEANX Balance</h4>
      <p id="aseanxBalance" class="fw-semibold"></p>
    </div>
  </div>
<!-- ‚úÖ Load Ethers.js (Works in all browsers including Edge) -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>

<script>
  const ASEANRegistryABI = [
    "function getModule(uint8) view returns (address)"
  ];

  const ASEANXABI = [
    "function balanceOf(address) view returns (uint256)",
    "function symbol() view returns (string)"
  ];

  const registryAddress = "0xF793721549fc423E62FcdB2491B378a55EB9bB4";
  const aseanxAddress = "0x44D7b726D4F64493E819C40ABB7f25d633bF404D";

  const moduleNames = [
    "ASEANXToken",
    "CitizenNFT",
    "Governance",
    "ProjectFunding",
    "Marketplace",
    "OracleBridge",
    "StakingVault",
    "Migration"
  ];

  let provider, signer;

  async function connectWallet() {
    try {
      if (!window.ethereum) {
        alert("MetaMask not detected.");
        return;
      }

      await window.ethereum.request({ method: 'eth_requestAccounts' });
      provider = new ethers.BrowserProvider(window.ethereum);
      signer = await provider.getSigner();
      const address = await signer.getAddress();

      document.getElementById('walletAddress').innerText = address;
      document.getElementById('connectBtn').innerText = "Connected";
      document.getElementById('connectBtn').disabled = true;

      // ‚úÖ Load balance and module list
      await getASEANXBalance(address);
      await fetchModules();

    } catch (err) {
      console.error("Wallet connection failed:", err);
      alert("Failed to connect wallet.");
    }
  }

async function fetchModules() {
  try {
    const normalizedRegistryAddress = ethers.getAddress(registryAddress);
    const registry = new ethers.Contract(normalizedRegistryAddress, ASEANRegistryABI, provider);
    const list = document.getElementById("moduleList");
    list.innerHTML = "";

    for (let i = 0; i < moduleNames.length; i++) {
      const addr = await registry.getModule(i);
      console.log(`Module ${moduleNames[i]} (index ${i}):`, addr);

      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      li.innerHTML = `<span>${moduleNames[i]}</span><code>${addr}</code>`;

      list.appendChild(li);
    }
  } catch (err) {
    console.error("‚ùå Error fetching modules from ASEANRegistry:", err);
    alert("Failed to load modules from registry. See console for details.");
  }
}


  async function getASEANXBalance(address) {
    try {
      const token = new ethers.Contract(aseanxAddress, ASEANXABI, provider);
      const balance = await token.balanceOf(address);
      const symbol = await token.symbol();
      document.getElementById("aseanxBalance").innerText = `${ethers.formatUnits(balance, 18)} ${symbol}`;
    } catch (err) {
      console.error("Balance fetch error:", err);
    }
  }

  document.getElementById("connectBtn").addEventListener("click", connectWallet);
</script>


</body>
</html>
