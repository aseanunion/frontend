<div class="card">
  <div class="card-header bg-dark text-white">
    üó≥Ô∏è ASEAN UNION ‚Äì Law & Policy Voting
  </div>
  <div class="card-body">
    <p>Citizens can vote on proposed regulations, laws, and tax reforms.</p>
    <div id="proposalList" class="row g-3"></div>
  </div>
</div>

<script>
const governanceABI = [
  "function getAllProposals() view returns (tuple(uint256 id, string title, uint8 voteType, uint256 countryId, string description, string[] images, string[] candidates, uint256 deadline, uint256[] voteCounts, bool executed)[])",
  "function vote(uint256 proposalId, uint256 choice) public"
];

async function loadProposals() {
  const contract = getContract("Governance", governanceABI);
  const proposals = await contract.getAllProposals();
  const container = document.getElementById("proposalList");
  container.innerHTML = "";

  const now = Math.floor(Date.now() / 1000);

  for (const p of proposals) {
    if (p.voteType !== 0) continue; // Only include VoteType.Rule (0)

    const expired = now > Number(p.deadline);
    const div = document.createElement("div");
    div.className = "col-md-6";

    div.innerHTML = `
      <div class="card border-${expired ? 'secondary' : 'primary'} shadow-sm">
        <div class="card-body">
          <h5 class="card-title">${p.title}</h5>
          <p class="card-text">${p.description}</p>
          <p>
            <span class="badge bg-success">‚úÖ Yes: ${p.voteCounts[0]}</span>
            <span class="badge bg-danger ms-2">‚ùå No: ${p.voteCounts[1]}</span>
          </p>
          <small class="text-muted d-block mb-2">Deadline: ${new Date(p.deadline * 1000).toLocaleString()}</small>
          ${!expired && window.isCitizen ? `
            <button class="btn btn-success btn-sm me-2" onclick="castVote(${p.id}, 0)">‚úÖ Yes</button>
            <button class="btn btn-danger btn-sm" onclick="castVote(${p.id}, 1)">‚ùå No</button>
          ` : `<span class="badge bg-secondary">Voting closed</span>`}
        </div>
      </div>
    `;
    container.appendChild(div);
  }
}

async function castVote(id, choice) {
  try {
    const contract = getContract("Governance", governanceABI);
    const tx = await contract.connect(signer).vote(id, choice);
    await tx.wait();
    alert("‚úÖ Vote submitted!");
    await loadProposals();
  } catch (e) {
    alert("‚ùå Error: " + (e.reason || e.message));
  }
}

loadProposals();
</script>
